---
title: "Some exploratory analyses"
author: "Petre Buciu"
---

Let us decompose the value added generated by final demand categories for the eastern european countries between 1995 and 2018. Let us see Romania first.

```{r}
#|fig-width: 8
#|fig-height: 6
#|fig-dpi: 200
library(tidyverse)
library(ggthemes)
theme_set(hrbrthemes::theme_ipsum_tw())
vax <- read_csv(here::here("data", "vax.csv"))
vaxd <- read_csv(here::here("data", 'vaxd.csv'))
ro <- read_csv(here::here("data", "romania_sda.csv"))

ro %>% group_by(sector) %>% 
  mutate(across(dM:df, cumsum)) %>% ungroup() %>% 
  mutate(total=dM+dL+df) %>% 
  ggplot(aes(x=year, y=total, fill=sector)) + 
  geom_col() + scale_fill_tableau() + 
  labs(title="Value added decomposition", subtitle="By final demand categories",
       x=NULL, y="million USD") + 
  scale_y_continuous(labels = scales::number_format())
```

```{r}
#| fig-width: 8
#| fig-height: 6
#| fig-dpi: 200

ro %>% group_by(year) %>% 
  summarise(across(dM:df, sum)) %>% ungroup() %>% 
  mutate_at(vars(dM:df), cumsum) %>% 
  gather(2:4, key='component', value='valoare') %>% 
  ggplot(aes(x=year, y=valoare, group=component)) + 
  geom_col(aes(fill=component)) + scale_fill_tableau() +
  labs(title="Structural decomposition analysis of VA", 
       x=NULL, y="Million USD") +
  scale_y_continuous(labels=scales::number_format())

```

We can see that almost all the value added between 1995 and 2018 is due to final demand growing in this time. Also, exports are more important in the generation of value added since the Great Financial Crisis.

Let us see Eastern Europe relative contribution to value added before and after the financial crisis.

```{r}
#| fig-width: 10
#| fig-height: 10
#| fig-dpi: 200

vax %>% filter(year!=2008) %>% 
  filter(grepl("Eastern", clasificare)) %>% 
  group_by(country, component, 
           year=if_else(year<2008, "1995-2007", "2009-2018")) %>% 
  summarise(VAR=100*mean(VA)/mean(total)) %>% 
  ggplot(aes(x=year, y=VAR, fill=component)) + 
  geom_col(aes(fill=component)) + 
  facet_wrap(~country, ncol=2, scales='free') + 
  scale_fill_tableau() + 
  labs(title="Relative contribution to VA growth", x=NULL, y=NULL) +
  scale_y_continuous(labels=scales::percent_format(scale=1))
```

As it was to be expected, our countries are now more export-oriented.

Why does Croatia look that way, also different from your study ?

```{r}
#| fig-width: 8
#| fig-height: 6
#| fig-dpi: 200

vax %>% filter(grepl("Eastern", clasificare)) %>% 
  mutate(VAR=100*VA/total) %>% filter(country=="Croatia") %>% 
  group_by(component) %>% mutate(VA=cumsum(VA)) %>% 
  ggplot(aes(x=year, y=VA, fill=component)) + geom_col() +
  labs(title="Croatia VA decomposed", x=NULL, y="million USD")+
  scale_y_continuous(labels=scales::number_format()) +
  scale_fill_tableau()
```

It is hard to see problems with graph so maybe we plot annual changes:

```{r}
#| fig-width: 8
#| fig-height: 6
#| fig-dpi: 200
vax %>% filter(grepl("Eastern", clasificare)) %>% 
  mutate(VAR=100*VA/total) %>% filter(country=="Croatia") %>% 
  ggplot(aes(x=year, y=VA, fill=component)) + geom_col() + 
  scale_fill_tableau() + 
  labs(title='Annual VA changes decomposed', x=NULL, y="million USD")



```

We can see more clearly now that we had negative (absolute) contributions from exports in a few years after the financial crisis and some constant contributions afterwards. They mostly cancel out but they remain positive (actually the only positive component in the 2009-2018 period). So we will use the math module function for the total value added so we can have positive contribution of positive components even when growth is negative.

Let us see mediterranean/mixed economies:

```{r}
#| fig-width: 10
#| fig-height: 10
#| fig-dpi: 200

vax %>% filter(year!=2008) %>% filter(country!="Cyprus") %>%
  filter(grepl("Mediterranean", clasificare)) %>% 
  group_by(country, component, 
           year=if_else(year<2008, "1995-2007", "2009-2018")) %>% 
  summarise(VAR=100*mean(VA)/abs(mean(total))) %>% 
  ggplot(aes(x=year, y=VAR, fill=component)) + 
  geom_col(aes(fill=component)) + 
  facet_wrap(~country, ncol=2, scales='free') + 
  scale_fill_tableau() + 
  labs(title="Relative contribution to VA growth", 
       subtitle="Mediterranean/mixed economies", x=NULL, y=NULL) +
  scale_y_continuous(labels=scales::percent_format(scale=1))
```

And cumulative yearly changes:

```{r}
#| fig-width: 10
#| fig-height: 10
#| fig-dpi: 200

vax %>% filter(grepl("Mediterranean", clasificare)) %>% 
  mutate(VAR=100*VA/total) %>% filter(country!="Cyprus") %>%
  group_by(component, country) %>% mutate(VA=cumsum(VA)) %>% 
  ggplot(aes(x=year, y=VA, fill=component)) + geom_col() +
  labs(title="Mediterranean VA decomposed", x=NULL, y="million USD")+
  scale_y_continuous(labels=scales::number_format()) +
  scale_fill_tableau() +
  facet_wrap(~country, ncol=2, scales='free') +
  theme(legend.position = 'top')
```
